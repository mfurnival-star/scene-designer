# Scene Designer – Engineering & Review Instructions

These instructions are binding for all development, code review, and delivery in the Scene Designer project.

---

## 1. ES Module Enforcement

- All code must use ES module syntax for imports and exports.
- No use of window.*, global variables, or global libraries.
- External dependencies (e.g., Konva, Pickr, Golden Layout) must be imported as ES modules.

### 1A. Transitional Exception: Remote Logging via Console.Re

- Remote log streaming must use the official Console.Re connector script:
  ```html
  <script src="//console.re/connector.js" data-channel="scene-designer"></script>
  ```
- This ensures compatibility with the current Console.Re dashboard and captures early errors.
- The legacy npm UMD CDN (`console-remote-client`) is deprecated and MUST NOT be used except for backward compatibility with older builds.
- This exception is strictly for remote logging only.
- All other dependencies and code must remain ES module–only and avoid global/window usage.
- Remove this exception as soon as Console.Re provides a proper ES module export.

---

## 2. Import/Export Consistency

- Every import must be satisfied by a real export in the source file.
- Update the source or import as needed to ensure consistency.
- Enforce for all code changes and file deliveries.

---

## 3. File Delivery and Review Workflow

- All code delivery, review, and requests operate on complete files only (never snippets).
- File-by-file delivery workflow:
  1. List all files to be delivered up front, with explicit numbering (e.g., 1. fileA.js, 2. fileB.js, ...).
  2. Deliver each file, one at a time, in the order listed.
  3. After each file, state the name and number of the next file to expect (e.g., "Next file: 2. sidebar.js").
  4. Wait for explicit confirmation ("next", "ready", etc.) before delivering the next file.
  5. Keep a running list of remaining files/numbers in each reply until all are delivered.
  6. After all files, explicitly confirm completion (e.g., "All files delivered. Refactor complete.").
- If a module is added, removed, or renamed, update `src/modules.index.md`.

---

## 4. File Size Policy and Splitting

- No single file should exceed ~350 lines.
- If a file does, split into logical ES module parts (e.g., `settings-core.js`, `settings-ui.js`, or `settings.part1.js`, `settings.part2.js`).
- Each part should be ≤350 lines if possible.
- When splitting:
  - Prefer logical separation (core, UI, data, helpers, etc).
  - Each part must begin with a summary comment.
  - Update all imports/exports to use new modules.
  - Update `src/modules.index.md` to list all new files.
  - Document the split in the PR/commit summary.
- This policy is mandatory for all new code and for any refactoring of large files.

---

## 5. Logging and Documentation

- Use the shared logger (`log()`) from `log.js` with proper log levels and tags.
  - `ERROR`, `WARN`, `INFO`, `DEBUG`, `TRACE` (TRACE is very verbose; rarely used).
- Never use `console.log` directly except inside the logger implementation.
- Every module/file must begin with a comment summarizing purpose, exports, and dependencies.
- All cross-module communication must use ES module imports/exports.

---

## 6. Example (Good/Bad)

```js
// Good
import Konva from "konva";
import { buildSidebarPanel } from "./sidebar.js";

// Bad
const stage = new window.Konva.Stage(...);   // ❌ Not allowed
window.Pickr.create(...);                    // ❌ Not allowed
import { foo } from "./notExportedHere.js";  // ❌ Not allowed if not exported
```

---

## 7. State Management (Zustand-style, 2025 Update)

- All state flows through exported functions and the store object in `state.js`.
  - Use `getState()` to access the current state object.
  - Use mutators like `setShapes`, `addShape`, `removeShape`, etc.
  - Subscribe to state changes via `sceneDesignerStore.subscribe(fn)`.
  - Do not import a singleton `AppState` object.

---

## 8. Action/Intent-Based Separation of Concerns

- UI components emit "intents" or "actions" to dedicated handler modules.
  - Toolbar, keyboard shortcuts, and other panels DO NOT contain business logic for deletion, duplication, locking, etc.
  - All business logic for scene actions (delete, duplicate, lock, unlock, add shape, etc.) is centralized in `src/actions.js`.
  - Cross-module communication always uses ES module imports/exports.

---

## 9. Manifest and Documentation Updates

- All new modules (added/removed/renamed) must be reflected in `src/modules.index.md`.
- Update this file and the module manifest as needed to document architecture changes.

---

## 10. Auto-generated Files / Artifacts

- The file `src/exports.index.json` is auto-generated by tooling. Do not edit it by hand.
  - It may change when exports are added/removed/moved. Treat diffs as generated output during review.
  - If it appears out of sync locally, run the usual dev/build task to regenerate.
  - PRs may include this file; reviewers should not request manual edits to it.

Notes:
- `src/modules.index.md` remains curated manually and must be updated for module add/remove/rename events.
- The shapes module has been split: `src/shapes.js` is a facade re-exporting `src/shapes-core.js` and `src/shapes-point.js`. All imports should continue to target `./shapes.js`.

---

## 11. Module Inventory and Recent Changes (2025-09-22)

The following modules were added/split to comply with the file size policy and improve separation of concerns. Public import paths remain unchanged where facades are provided.

- Selection (split)
  - src/selection-core.js
    - Centralized single/multi selection logic and transformer lifecycle.
    - Owns state updates and shape-state integration.
  - src/selection-outlines.js
    - Renders dashed multi-select outlines (blue for normal, red for locked).
    - Non-interactive; excluded from export and duplication.
  - src/selection.js
    - Facade re-export of the public selection API from selection-core.js.
    - Public imports should continue to use: import { ... } from './selection.js'.

- MiniLayout (split)
  - src/minilayout-core.js
    - Core layout engine (rows, columns, stacks, components).
    - Delegates splitter sizing/persistence to dedicated module.
  - src/minilayout-splitter-persist.js
    - Splitter elements and panel size persistence (localStorage).
    - Reusable for row/column containers; percent-based sizing.
  - src/minilayout.js
    - Facade re-export: export { MiniLayout } from './minilayout-core.js'.
    - Public imports should continue to use: import { MiniLayout } from './minilayout.js'.

- Pre-existing splits (unchanged)
  - src/shapes.js
    - Facade re-export of shapes-core.js and shapes-point.js.
  - src/settings.js
    - Facade re-export of settings-core.js and settings-ui.js.

Public API stability
- No external import paths changed. Continue using:
  - Selection: ./selection.js
  - MiniLayout: ./minilayout.js
  - Shapes: ./shapes.js
  - Settings: ./settings.js

---

## 12. Commit/PR Notes for the Split

- Include in PR summary:
  - "Split selection into selection-core.js and selection-outlines.js; selection.js remains as facade."
  - "Split MiniLayout into minilayout-core.js and minilayout-splitter-persist.js; minilayout.js remains as facade."
  - "No public API/import path changes; exports.index.json remains valid."
- Verify:
  - All imports updated where internal modules are used.
  - Lints/builds pass and UI behavior unchanged.
  - Files adhere to the ~350 line guideline.

---

## 13. Toolbar Split (2025-09-21)

To address a syntax error in the monolithic toolbar and comply with the file-size policy, the toolbar was split into cohesive ES modules. Public imports remain stable via the facade.

- Facade (public import path unchanged)
  - src/toolbar.js
    - Facade that re-exports buildCanvasToolbarPanel from toolbar-panel.js.
    - External imports should continue using: import { buildCanvasToolbarPanel } from './toolbar.js'.

- Split modules
  - src/toolbar-panel.js
    - Panel assembly: injects styles, renders DOM, wires handlers, and installs state-driven enable/disable logic.
    - Exports: buildCanvasToolbarPanel({ element, title, componentName }).
  - src/toolbar-styles.js
    - Injects toolbar CSS once.
    - Ensures buttons auto-size to text; scaling via font-size so widths reflow with scale.
    - Exports: ensureToolbarStylesInjected().
  - src/toolbar-dom.js
    - Renders toolbar HTML into the provided element and returns strong refs to interactive nodes.
    - No business logic or event wiring.
    - Exports: renderToolbar(element).
  - src/toolbar-handlers.js
    - Attaches all click/change handlers.
    - Dispatches intents to actions.js and selection.js (no business logic).
    - Exports: attachToolbarHandlers(refs) -> detachFn.
  - src/toolbar-state.js
    - Derives button enabled/disabled state from the store; syncs toolbar scale with settings.toolbarUIScale.
    - Exports: installButtonsStateSync(refs) -> detachFn, installToolbarScaleSync(containerEl) -> detachFn.

Notes:
- No public API change: layout.js continues to import buildCanvasToolbarPanel from './toolbar.js'.
- exports.index.json remains correct, since toolbar.js still exports buildCanvasToolbarPanel; the generator can remain unchanged.
- The split resolves the Vite import-analysis syntax error originating from the previous monolithic file and keeps each module well under ~350 lines.

PR summary guidance for this split:
- "Split toolbar into toolbar-panel.js, toolbar-styles.js, toolbar-dom.js, toolbar-handlers.js, toolbar-state.js; toolbar.js remains a facade."
- "Fixed invalid JS syntax in the old toolbar (template literal closing) by replacing it with split modules."
- "No business logic moved; actions remain centralized in src/actions.js."

Acceptance checklist:
- Toolbar renders with auto-sized buttons and updated font stack.
- Toolbar scale changes update widths correctly (no transform scaling).
- Add/Delete/Duplicate/Reset Rotation/Select All/Lock/Unlock all wired and enabled/disabled states derive from store correctly.
- Build/dev runs without Vite syntax errors.

---

## 14. P1 Triage Fixes: Multi-select drag clamping, lock UX, iOS double‑tap suppression (2025-09-21)

New module
- src/canvas-constraints.js
  - Purpose: Centralize Fabric object movement guards and clamping.
  - Export: installCanvasConstraints(canvas) -> detachFn.
  - Behavior:
    - On object:moving:
      - If target is an ActiveSelection and any member is locked → block the move (revert to previous left/top).
      - Clamp the moving target’s bounding rect to the background image bounds for both single objects and ActiveSelection hulls.
    - Tracks target._prevLeft/_prevTop to support revert on blocked multi-drag.

Updated modules
- src/actions.js
  - Lock/unlock UX reworked to keep shapes selectable while preventing transforms/movement:
    - lockSelectedShapes() keeps shapes selectable/evented, sets Fabric movement/transform locks, hover cursor 'not-allowed'.
    - unlockSelectedShapes() clears Fabric locks; works on selection or all locked when none selected.

- src/canvas-core.js
  - Installs movement constraints (installCanvasConstraints).
  - Suppresses iOS double‑tap zoom in canvas area.
  - Installs overlay dashed outlines for multi-select on top context.

Acceptance outcomes
- Group drag is clamped to image bounds; any locked member blocks group drag.
- Locked shapes remain selectable; unlock works with or without an active selection.
- On iPhone Safari, double‑tapping inside the canvas does not zoom.

---

## 15. Multi-select outlines overlay refactor (2025-09-21)

- src/selection-outlines.js
  - paints multi-select per-shape and hull dashed boxes on Fabric’s top context.
  - Blue normally; red if any selected is locked.
  - No Fabric outline objects remain; avoids “ghost dashed boxes”.

- src/canvas-core.js
  - Installs the overlay painter via installSelectionOutlines(canvas).

---

## 16. STY-01 Pickr Integration (2025-09-22)

Goal
- Replace native color inputs and alpha slider with Pickr-based color pickers.
- Stroke uses hex only; Fill uses hex + opacity.

New module
- src/toolbar-color.js
  - Purpose: Encapsulate @simonwep/pickr integration for stroke/fill color controls.
  - Export: installColorPickers({ strokePickrEl, fillPickrEl }) -> detachFn.
  - Behavior:
    - If shapes are selected: live-apply stroke/fill(+alpha) to all unlocked selected shapes via shapes.js.
    - If none selected: update defaults in settings (persisted) using settings-core.js.
  - ESM import:
    ```js
    import Pickr from '@simonwep/pickr';
    import '@simonwep/pickr/dist/themes/classic.min.css';
    ```

Updated modules
- src/toolbar-dom.js
  - Replaces:
    - input[type="color"] stroke/fill
    - range alpha slider
  - With:
    - Two Pickr host buttons: #toolbar-stroke-pickr and #toolbar-fill-pickr.
- src/toolbar-handlers.js
  - Installs Pickr controls by calling installColorPickers(refs).
  - Removes native color/alpha wiring.
- src/toolbar-styles.js
  - Adds styling for Pickr host buttons to match toolbar look and feel.
- src/toolbar-panel.js
  - No public API change; continues to assemble styles/DOM/handlers/state.
  - Now indirectly wires Pickr via handlers.

Notes
- Public import path unchanged (still import { buildCanvasToolbarPanel } from './toolbar.js').
- exports.index.json remains valid (auto-generated).
- Dependency: @simonwep/pickr must be present in package.json and imported as ESM.

Acceptance
- With selection:
  - Stroke picker updates stroke color on unlocked Rect/Circle and Point reticle lines/rings.
  - Fill picker updates Rect/Circle fill; for Point, only halo-like semi-transparent circles change.
- Without selection:
  - Stroke picker updates settings.defaultStrokeColor (#RRGGBBAA with FF alpha).
  - Fill picker updates settings.defaultFillColor (#RRGGBBAA).
- Stroke remains strokeUniform for shapes that support it.
- Pickr UI loads with defaults from settings and reflects changes live.

---

## 17. Public Facades (unchanged)

- src/toolbar.js → export { buildCanvasToolbarPanel } from './toolbar-panel.js'
- src/shapes.js → re-exports from shapes-core.js and shapes-point.js
- src/settings.js → re-exports from settings-core.js and settings-ui.js
- src/selection.js → re-exports from selection-core.js

---

## 18. Verification Checklist (running dev)

- Ensure @simonwep/pickr is installed and resolves as an ES module.
- Toolbar renders:
  - Stroke/Fill “Pick” buttons present; opening shows Pickr popover.
  - Buttons auto-size; toolbar scales via settings.toolbarUIScale.
- Actions: Add/Delete/Duplicate/Reset Rotation/Select All/Lock/Unlock work and enable/disable correctly.
- Color behavior:
  - Live updates when selection exists; defaults updated when none selected.
  - Point halo-only fill changes when applicable; hit target and cutout holes remain untouched.
- Build/dev has no Vite syntax errors.

---

